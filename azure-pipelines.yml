trigger:
  branches:
    include:
      - master

pool:
  name: 'adc'
  demands:
    - agent.name -equals docker00

variables:
  - group: 'sonarqube'  # Should contain: SONAR_PROJECT_KEY, SONAR_HOST_URL, SONAR_TOKEN
  - name: GOVERSION
    value: '1.21'

steps:
  # Install Java (required for SonarQube Scanner)
  - script: |
      if ! command -v java &> /dev/null; then
        sudo apt-get update
        sudo apt-get install -y openjdk-17-jdk
      fi
      export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))
      echo "JAVA_HOME is $JAVA_HOME"
      echo "##vso[task.setvariable variable=JAVA_HOME]$JAVA_HOME"
      echo "##vso[task.prependpath]$JAVA_HOME/bin"
      java -version
    displayName: 'Setup Java 17'

  # Install SonarScanner CLI
  - script: |
      wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
      unzip -q sonar-scanner-cli-5.0.1.3006-linux.zip
      echo "##vso[task.prependpath]$(pwd)/sonar-scanner-5.0.1.3006-linux/bin"
    displayName: 'Install SonarScanner CLI'

  # Check Go installation
  - script: |
      if ! command -v go &> /dev/null; then
        echo "##vso[task.logissue type=error]Go is not installed on this agent"
        exit 1
      fi
      go version
      echo "Go is available at: $(which go)"
    displayName: 'Verify Go Installation'

  # Get Go dependencies
  - script: |
      go mod download
    displayName: 'Download Go dependencies'

  # Build the application
  - script: |
      go build -v -o go-gantt .
    displayName: 'Build Go application'

  # Run tests with coverage
  - script: |
      go test -v -coverprofile=coverage.out ./...
    displayName: 'Run tests with coverage'
    continueOnError: true

  # Run SonarQube Analysis
  - script: |
      sonar-scanner \
        -Dsonar.projectKey=$(SONAR_PROJECT_KEY) \
        -Dsonar.projectName=go-gantt \
        -Dsonar.sources=. \
        -Dsonar.host.url=$(SONAR_HOST_URL) \
        -Dsonar.token=$(SONAR_TOKEN) \
        -Dsonar.go.coverage.reportPaths=coverage.out
    displayName: 'Run SonarQube Analysis'
