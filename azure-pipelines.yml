trigger:
  branches:
    include:
      - master

pool:
  name: 'adc'

variables:
  - group: 'sonarqube'
  - name: GOVERSION
    value: '1.21'

steps:
  # Check and install Java (required for SonarQube)
  - script: |
      if ! command -v java &> /dev/null; then
        sudo apt-get update
        sudo apt-get install -y openjdk-17-jdk
      fi
      export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))
      echo "JAVA_HOME is $JAVA_HOME"
      echo "##vso[task.setvariable variable=JAVA_HOME]$JAVA_HOME"
      echo "##vso[task.prependpath]$JAVA_HOME/bin"
      java -version
    displayName: 'Setup Java 17'

  # Prepare Analysis Configuration
  - task: SonarQubePrepare@5
    displayName: 'Prepare SonarQube Analysis'
    inputs:
      SonarQube: 'SonarQube'
      scannerMode: 'CLI'
      configMode: 'manual'
      cliProjectKey: '$(SONAR_PROJECT_KEY)'
      cliProjectName: 'go-gantt'
      cliSources: '.'

  # Set up Go environment
  - task: GoTool@0
    displayName: 'Set up Go'
    inputs:
      version: '$(GOVERSION)'

  # Get Go dependencies
  - script: |
      go mod download
    displayName: 'Download Go dependencies'

  # Build the application
  - script: |
      go build -v -o go-gantt .
    displayName: 'Build Go application'

  # Run tests (optional but recommended)
  - script: |
      go test -v ./...
    displayName: 'Run tests'
    continueOnError: true

  # Run Code Analysis
  - task: SonarQubeAnalyze@5
    displayName: 'Run SonarQube Code Analysis'

  # Publish Quality Gate Result
  - task: SonarQubePublish@5
    displayName: 'Publish SonarQube Quality Gate Result'
    inputs:
      pollingTimeoutSec: '300'
