trigger:
  branches:
    include:
      - master

pool:
  name: 'adc'
  demands:
    - agent.name -equals docker00

variables:
  - group: 'sonarqube'  # Should contain: SONAR_PROJECT_KEY, SONAR_HOST_URL, SONAR_TOKEN
  - name: GOVERSION
    value: '1.23.3'

steps:
  # Install Java (required for SonarQube Scanner)
  - script: |
      if ! command -v java &> /dev/null; then
        sudo apt-get update
        sudo apt-get install -y openjdk-17-jdk
      fi
      export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))
      echo "JAVA_HOME is $JAVA_HOME"
      echo "##vso[task.setvariable variable=JAVA_HOME]$JAVA_HOME"
      echo "##vso[task.prependpath]$JAVA_HOME/bin"
      java -version
    displayName: 'Setup Java 17'

  # Install SonarScanner CLI
  - bash: |
      BUILD_DIR="$(Agent.BuildDirectory)"
      cd "$BUILD_DIR"
      
      # Remove old installations and downloads
      rm -rf sonar-scanner-* 2>/dev/null || true
      
      # Download
      wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
      
      # Extract using Python (no sudo needed)
      python3 -m zipfile -e sonar-scanner-cli-5.0.1.3006-linux.zip .
      
      # Verify extraction
      if [ ! -d "sonar-scanner-5.0.1.3006-linux" ]; then
        echo "ERROR: Failed to extract SonarScanner"
        ls -la
        exit 1
      fi
      
      # Make sonar-scanner executable
      chmod +x sonar-scanner-5.0.1.3006-linux/bin/sonar-scanner
      
      SCANNER_PATH="$BUILD_DIR/sonar-scanner-5.0.1.3006-linux/bin"
      echo "SonarScanner installed at: $SCANNER_PATH"
      ls -la "$SCANNER_PATH"
      echo "##vso[task.setvariable variable=SCANNER_PATH]$SCANNER_PATH"
    displayName: 'Install SonarScanner CLI'

  # Install Go
  - task: GoTool@0
    inputs:
      version: '$(GOVERSION)'
    displayName: 'Install Go $(GOVERSION)'

  # Verify Go installation
  - script: |
      go version
      echo "Go is available at: $(which go)"
    displayName: 'Verify Go Installation'

  # Get Go dependencies
  - script: |
      go mod download
    displayName: 'Download Go dependencies'

  # Build the application
  - script: |
      go build -v -o go-gantt .
    displayName: 'Build Go application'

  # Run tests with coverage
  - script: |
      go test -v -coverprofile=coverage.out ./...
    displayName: 'Run tests with coverage'
    continueOnError: true

  # Run SonarQube Analysis
  - bash: |
      echo "SCANNER_PATH variable: $SCANNER_PATH"
      echo "JAVA_HOME variable: $JAVA_HOME"
      
      if [ -f "$SCANNER_PATH/sonar-scanner" ]; then
        echo "SonarScanner found at: $SCANNER_PATH/sonar-scanner"
        
        # Add Java to PATH and verify
        export PATH="$JAVA_HOME/bin:$PATH"
        which java
        java -version
        
        # Debug: Check what sonar-scanner is looking for
        echo "PATH is: $PATH"
        echo "Checking sonar-scanner script..."
        head -20 "$SCANNER_PATH/sonar-scanner"
        
        # Modify sonar-scanner to use our JAVA_HOME
        # Create a wrapper script
        cat > /tmp/sonar-wrapper.sh << 'EOF'
#!/bin/bash
export JAVA_HOME="$JAVA_HOME"
export PATH="$JAVA_HOME/bin:$PATH"
exec "$SCANNER_PATH/sonar-scanner" "$@"
EOF
        chmod +x /tmp/sonar-wrapper.sh
        
        # Run via wrapper
        JAVA_HOME="$JAVA_HOME" SCANNER_PATH="$SCANNER_PATH" /tmp/sonar-wrapper.sh \
          -Dsonar.projectKey=$(SONAR_PROJECT_KEY) \
          -Dsonar.projectName=go-gantt \
          -Dsonar.sources=. \
          -Dsonar.host.url=$(SONAR_HOST_URL) \
          -Dsonar.token=$(SONAR_TOKEN) \
          -Dsonar.go.coverage.reportPaths=coverage.out
      else
        echo "ERROR: SonarScanner not found at: $SCANNER_PATH/sonar-scanner"
        exit 1
      fi
    displayName: 'Run SonarQube Analysis'
    env:
      SONAR_PROJECT_KEY: $(SONAR_PROJECT_KEY)
      SONAR_HOST_URL: $(SONAR_HOST_URL)
      SONAR_TOKEN: $(SONAR_TOKEN)
      JAVA_HOME: $(JAVA_HOME)
